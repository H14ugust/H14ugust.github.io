<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>http的长连接和短连接、保活机制 | H14ugust&#39;s Blog</title>
  
  
  
  <!--link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css"-->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<div class="Shell">
    <aside class='SideBar'>
    <section class='avatar' style="background-image: url()">
        <div class='av-pic' style="background-image: url()">
        </div>
    </section>
    <section class='menu'>
        <div>H14ugust&#39;s Blog</div>
        
        <ul>
          
            <a href="/" class="Btn">
              <li>Home</li>
            </a>  
          
            <a href="/archives/" class="Btn">
              <li>Archive</li>
            </a>  
          
            <a href="/tags/" class="Btn">
              <li>Tags</li>
            </a>  
          
            <a href="/categories/" class="Btn">
              <li>Categories</li>
            </a>  
          
            <a href="/about/" class="Btn">
              <li>About</li>
            </a>  
          
        </ul>
    </section>
    <section class="media">
        
    </section>
</aside>

    <div class="container">
        <div data-pager-shell>
            <div>
  <article class='ContentView'>
    <header class='PageTitle'>
        <h1>http的长连接和短连接、保活机制</h1>
    </header>

    <section>
      <h2 id="http连接"><a href="#http连接" class="headerlink" title="http连接"></a>http连接</h2><p>http的长连接和短连接<strong>本质上是TCP长连接和短连接</strong>。HTTP属于应用层协议，在传输层使用TCP协议，在网络层使用IP协议。 IP协议主要解决网络路由和寻址问题，TCP协议主要解决如何在IP层之上可靠地传递数据包，使得网络上接收端收到发送端所发出的所有包，并且顺序与发送顺序一致。TCP协议是可靠的、面向连接的。</p>
<p>http协议是无状态的，指的是协议对于事务处理没有记忆能力，服务器不知道客户端是什么状态。也就是说，打开一个服务器上的网页和上一次打开这个服务器上的网页之间没有任何联系。HTTP是一个无状态的面向连接的协议，无状态不代表HTTP不能保持TCP连接，更不能代表HTTP使用的是UDP协议（无连接）。</p>
<a id="more"></a>
<h2 id="TCP连接"><a href="#TCP连接" class="headerlink" title="TCP连接"></a>TCP连接</h2><p>当网络通信时采用TCP协议时，在真正的读写操作之前，客户端与服务器端之间必须建立一个连接，当读写操作完成后，双方不再需要这个连接时可以释放这个连接。<strong>连接的建立依靠“三次握手”，而释放则需要“四次挥手”</strong>，所以每个连接的建立都是需要资源消耗和时间消耗的。</p>
<h2 id="长连接-持久连接"><a href="#长连接-持久连接" class="headerlink" title="长连接(持久连接)"></a>长连接(持久连接)</h2><ul>
<li>client方与server方先建立连接，连接建立后不断开，然后再进行报文发送和接收。这种方式下由于通讯连接一直存在。此种方式常用于P2P点对点的通信。</li>
<li>长连接的操作步骤是：建立连接——数据传输…（保持连接）…数据传输——关闭连接</li>
<li>多用于操作频繁，点对点的通讯。</li>
</ul>
<h2 id="短连接"><a href="#短连接" class="headerlink" title="短连接"></a>短连接</h2><ul>
<li>client方与server每进行一次报文收发交易时才进行通讯连接，交易完毕后立即断开连接。此方式常用于一点对多点通讯。</li>
<li>短连接的操作步骤是：建立连接——数据传输——关闭连接…建立连接——数据传输——关闭连接</li>
<li>WEB网站的http服务一般都用短链接</li>
</ul>
<h2 id="Connection-keep-alive"><a href="#Connection-keep-alive" class="headerlink" title="Connection: keep-alive"></a>Connection: keep-alive</h2><p>为减少web服务短连接中创建连接过程中需要消耗的资源和时间，http/1.0和http/1.1中引入了重用连接的机制，就是在http请求头中加入 <code>Connection: keep-alive</code>来告诉服务器请求响应完毕后不要关闭连接。http/1.1默认支持长连接。</p>
<p>然而，协议的规定与现实中服务器和客户端的支持有所出入。</p>
<ul>
<li>在实践过程中发现谷歌浏览器使用HTTP/1.1协议时请求头中总会带上<code>Connection: keep-alive</code></li>
<li>通过httpclient使用HTTP/1.0协议去请求<strong>tomcat</strong>时，即使带上<code>Connection: keep-alive</code>请求头也保持不了长连接</li>
<li>如果HTTP/1.1版本的http请求报文不希望使用长连接，则要在请求头中加上<code>Connection: close</code>，接收到这个请求头的对端服务就会主动关闭连接</li>
</ul>
<h2 id="KeepAlive机制—保持长连接"><a href="#KeepAlive机制—保持长连接" class="headerlink" title="KeepAlive机制—保持长连接"></a>KeepAlive机制—保持长连接</h2><h3 id="htttp-keepalive"><a href="#htttp-keepalive" class="headerlink" title="htttp keepalive"></a>htttp keepalive</h3><p>在http早期，每个http请求都要求打开一个tpc socket连接，并且使用一次之后就断开这个tcp连接。</p>
<p>使用keep-alive可以改善这种状态，即在一次TCP连接中可以持续发送多份数据而不会断开连接。通过使用keep-alive机制，可以减少tcp连接建立次数，也意味着可以减少TIME_WAIT状态连接，以此提高性能和提高httpd服务器的吞吐率(更少的tcp连接意味着更少的系统内核调用,socket的accept()和close()调用)。</p>
<h3 id="TCP-keepalive"><a href="#TCP-keepalive" class="headerlink" title="TCP keepalive"></a>TCP keepalive</h3><p>TCP keepalive指的是TCP保活计时器（keepalive timer）。TCP协议实现中，也是有保活机制的，也就是TCP的KeepAlive机制（此机制并不是TCP协议规范中的内容，由操作系统去实现，该机制中的参数是可调的）。</p>
<p>尽管TCP本身提供了保活机制，但一个可靠的系统，长连接的保活肯定仍是要依赖<strong>应用层的心跳</strong>来保证的。</p>
<h3 id="心跳包"><a href="#心跳包" class="headerlink" title="心跳包"></a>心跳包</h3><p>很多应用层协议都有HeartBeat机制，通常是客户端每隔一小段时间向服务器发送一个数据包，通知服务器自己仍然在线，并传输一些可能必要的数据。</p>


      

    </section>
    
      <section class='ArticleMeta'>
          <div>
            发布于&nbsp;
            <time datetime="2019-01-13T05:49:40.000Z" itemprop="datePublished">
              2019-01-13
            </time>
          </div>
          
            <div>
              tags: 
  <li class="meta-text">
  { <a href="/tags/WEB/">WEB</a> }
  </li>


            </div>
          
      </section>
    
    
</article>

  
</div>

            <footer>
    <div>© 2019 - H14ugust </div>
    <div>
        <span>
            Powered by <a href="https://hexo.io">Hexo</a>
        </span>
        ,
        <span>
            Theme - <a href="https://github.com/nameoverflow/hexo-theme-icalm">Icalm</a>
        </span>
    </div>
</footer>

        </div>
    </div>
</div>
<script src="/js/pager/dist/singlepager.js"></script>
<script>
var sp = new Pager('data-pager-shell')

</script>
</body>
</html>